<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tuma - Route Navigation</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #0066FF;
            --primary-dark: #0052CC;
            --success: #34C759;
            --warning: #FF9F0A;
            --danger: #FF3B30;
            --surface: #1C1C1E;
            --surface-elevated: #2C2C2E;
            --surface-high: #3A3A3C;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --text-tertiary: #636366;
            --border: #48484A;
            --safe-area-bottom: env(safe-area-inset-bottom);
            --safe-area-top: env(safe-area-inset-top);
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: #0A0A0B;
            color: var(--text-primary);
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-font-smoothing: antialiased;
        }

        /* Map Container - Full Screen */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .leaflet-container {
            background: #1a1a1a !important;
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        /* Loading State */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0A0A0B;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #0066FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Top Bar - Minimal and Clean */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 12px 16px;
            padding-top: calc(12px + var(--safe-area-top));
            z-index: 100;
        }

        .top-bar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
        }

        .route-info {
            flex: 1;
            text-align: center;
            padding: 0 12px;
        }

        .route-name {
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .route-stats-mini {
            display: flex;
            justify-content: center;
            gap: 16px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .stat-mini {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .verify-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .verify-btn.pickup {
            background: var(--warning);
            color: black;
        }

        .verify-btn.completed {
            background: var(--success);
        }

        /* Map Action Buttons - Right Side */
        .map-actions {
            position: fixed;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 90;
        }

        .map-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            color: #333;
        }

        .map-btn:active {
            transform: scale(0.95);
        }

        .map-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Bottom Navigation - Main Actions */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.85));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px;
            padding-bottom: calc(16px + var(--safe-area-bottom));
            z-index: 100;
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 14px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .nav-btn:active {
            transform: scale(0.98);
        }

        .nav-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
            grid-column: span 2;
        }

        .nav-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Sliding Panel - Route Details */
        .route-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1C1C1E;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + var(--safe-area-bottom));
            max-height: 75vh;
            overflow-y: auto;
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
        }

        .route-panel.show {
            transform: translateY(0);
        }

        .panel-handle {
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .close-panel {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Cash Widget */
        .cash-widget {
            background: linear-gradient(135deg, rgba(255, 159, 10, 0.2), rgba(255, 159, 10, 0.1));
            border: 1px solid var(--warning);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .cash-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .cash-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            text-align: center;
        }

        .cash-stat .label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            display: block;
        }

        .cash-stat .value {
            font-size: 18px;
            font-weight: 700;
            color: var(--warning);
        }

        /* Stops List */
        .stops-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stop-card {
            background: var(--surface-elevated);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 12px;
            border-left: 3px solid var(--border);
        }

        .stop-card.active {
            border-left-color: var(--primary);
            background: rgba(0, 102, 255, 0.1);
        }

        .stop-card.completed {
            opacity: 0.6;
            border-left-color: var(--success);
        }

        .stop-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
            background: var(--surface-high);
            color: white;
        }

        .stop-number.pickup {
            background: var(--warning);
            color: black;
        }

        .stop-number.delivery {
            background: var(--primary);
        }

        .stop-content {
            flex: 1;
        }

        .stop-address {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
        }

        .stop-details {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .payment-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 159, 10, 0.2);
            border: 1px solid var(--warning);
            border-radius: 20px;
            padding: 6px 12px;
            margin-top: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--warning);
        }

        /* Empty State */
        .empty-state {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 40px;
            background: var(--surface-elevated);
            border-radius: 20px;
            z-index: 100;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: white;
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .empty-state button {
            padding: 14px 28px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Live Tracking Pill */
        .tracking-pill {
            position: fixed;
            top: calc(80px + var(--safe-area-top));
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 90;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .tracking-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loadingContainer" class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Route...</div>
    </div>
    
    <!-- Map -->
    <div id="map"></div>

    <!-- Top Bar -->
    <div class="top-bar" id="topBar">
        <div class="top-bar-content">
            <button class="back-btn" onclick="goBack()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <div class="route-info">
                <div class="route-name" id="routeName">Loading...</div>
                <div class="route-stats-mini">
                    <div class="stat-mini">
                        <span id="stopsLeft">0</span> stops
                    </div>
                    <div class="stat-mini">
                        <span id="distance">0</span> km
                    </div>
                    <div class="stat-mini">
                        <span id="eta">0</span> min
                    </div>
                </div>
            </div>
            <button class="verify-btn" id="verifyBtn" onclick="openQuickVerification()">
                Verify
            </button>
        </div>
    </div>

    <!-- Live Tracking Indicator -->
    <div class="tracking-pill" id="trackingPill" style="display: none;">
        <div class="tracking-dot"></div>
        <span>Live</span>
    </div>

    <!-- Map Action Buttons -->
    <div class="map-actions">
        <button class="map-btn" onclick="centerOnLocation()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
            </svg>
        </button>
        <button class="map-btn" onclick="callCustomer()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
            </svg>
        </button>
        <button class="map-btn" onclick="refreshMap()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
        </button>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottomNav">
        <div class="nav-buttons">
            <button class="nav-btn" onclick="togglePanel()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
                </svg>
                Details
            </button>
            <button class="nav-btn" onclick="toggleOptimize()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13 3v9h9c0-4.97-4.03-9-9-9zm-2 0C6.03 3 2 7.03 2 12s4.03 9 9 9c1.83 0 3.54-.55 4.95-1.48l-3.54-3.54c-.46.17-.96.27-1.41.27-2.49 0-4.5-2.01-4.5-4.5S8.51 7.25 11 7.25c.45 0 .95.1 1.41.27l3.54-3.54C14.54 3.55 12.83 3 11 3z"/>
                </svg>
                Optimize
            </button>
            <button class="nav-btn primary" onclick="startNavigation()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
                </svg>
                Start Navigation
            </button>
        </div>
    </div>

    <!-- Route Details Panel -->
    <div class="route-panel" id="routePanel">
        <div class="panel-handle"></div>
        <div class="panel-header">
            <h2 class="panel-title">Route Details</h2>
            <button class="close-panel" onclick="togglePanel()">×</button>
        </div>
        
        <!-- Cash Widget -->
        <div id="cashWidgetContainer"></div>
        
        <!-- Stops List -->
        <div id="stopsList" class="stops-list"></div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-icon">📦</div>
        <h2>No Active Route</h2>
        <p>You don't have any active deliveries</p>
        <button onclick="window.location.href='./rider.html'">
            Back to Dashboard
        </button>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Route Module -->
    <script src="./route.js"></script>
    
    <!-- UI Logic -->
    <script>
        // Initialize after load
        window.addEventListener('load', function() {
            setTimeout(function() {
                // Hide loading
                const loader = document.getElementById('loadingContainer');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 300);
                }
                
                // Check for route
                if (window.GlobalState && GlobalState.route) {
                    // Update UI
                    document.getElementById('routeName').textContent = GlobalState.route.name || 'Active Route';
                    document.getElementById('trackingPill').style.display = 'flex';
                    
                    updateStats();
                    updateVerifyButton();
                    
                    // Initialize UI if available
                    if (typeof UIModule !== 'undefined') {
                        UIModule.displayStops();
                        UIModule.updateRouteStats();
                    }
                    
                    // Draw route
                    if (typeof MapModule !== 'undefined') {
                        MapModule.plotRoute();
                        MapModule.drawOptimizedRoute();
                    }
                } else {
                    // Show empty state
                    document.getElementById('topBar').style.display = 'none';
                    document.getElementById('bottomNav').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                }
            }, 2000);
        });

        function updateStats() {
            if (GlobalState && GlobalState.route) {
                const remaining = GlobalState.route.stops?.filter(s => !s.completed).length || 0;
                document.getElementById('stopsLeft').textContent = remaining;
                document.getElementById('distance').textContent = GlobalState.route.distance?.toFixed(1) || 0;
                document.getElementById('eta').textContent = GlobalState.route.duration || 0;
            }
        }

        function updateVerifyButton() {
            if (typeof RouteModule !== 'undefined') {
                const nextStop = RouteModule.getNextStop();
                const btn = document.getElementById('verifyBtn');
                
                if (nextStop) {
                    btn.textContent = nextStop.type === 'pickup' ? '📦 Pickup' : '📍 Deliver';
                    btn.className = `verify-btn ${nextStop.type}`;
                    btn.disabled = false;
                } else {
                    btn.textContent = '✓ Complete';
                    btn.className = 'verify-btn completed';
                    btn.disabled = true;
                }
            }
        }

        function goBack() {
            if (confirm('Leave this route?')) {
                window.location.href = './rider.html';
            }
        }

        function centerOnLocation() {
            if (GlobalState?.location && GlobalState.map) {
                GlobalState.map.setView([GlobalState.location.lat, GlobalState.location.lng], 16);
            }
        }

        function callCustomer() {
            if (typeof RouteModule !== 'undefined') {
                const nextStop = RouteModule.getNextStop();
                if (nextStop?.customerPhone) {
                    window.location.href = `tel:${nextStop.customerPhone}`;
                }
            }
        }

        function refreshMap() {
            if (typeof MapModule !== 'undefined') {
                MapModule.plotRoute();
                MapModule.drawOptimizedRoute();
            }
            updateStats();
        }

        function togglePanel() {
            const panel = document.getElementById('routePanel');
            panel.classList.toggle('show');
        }

        function toggleOptimize() {
            if (typeof RouteModule !== 'undefined') {
                RouteModule.optimizeRoute();
                if (typeof UIModule !== 'undefined') {
                    UIModule.refresh();
                }
                refreshMap();
            }
        }

        function startNavigation() {
            if (typeof NavigationModule !== 'undefined' && typeof RouteModule !== 'undefined') {
                const nextStop = RouteModule.getNextStop();
                if (nextStop) {
                    NavigationModule.startNavigation(nextStop);
                }
            }
        }

        function openQuickVerification() {
            if (typeof VerificationModule !== 'undefined' && typeof RouteModule !== 'undefined') {
                const nextStop = RouteModule.getNextStop();
                if (nextStop) {
                    VerificationModule.showModal(nextStop);
                }
            }
        }
    </script>
</body>
</html>
