<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuma - Sign In</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066FF;
            --whatsapp: #25D366;
            --background: #000000;
            --surface: #0A0A0A;
            --surface-elevated: #141414;
            --text-primary: #FFFFFF;
            --text-secondary: #888888;
            --border: #222222;
            --error: #FF3B30;
            --success: #00B969;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-container {
            width: 100%;
            max-width: 420px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 10px 40px rgba(0, 102, 255, 0.1);
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: var(--primary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            color: white;
        }

        h1 {
            text-align: center;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .user-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .user-type-card {
            background: var(--surface-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .user-type-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .user-type-card.active {
            border-color: var(--primary);
            background: rgba(0, 102, 255, 0.1);
        }

        .user-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .user-type-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-type-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .input-wrapper {
            position: relative;
        }

        .phone-prefix {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 14px 16px;
            background: var(--surface-elevated);
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            color: var(--text-primary);
            outline: none;
            transition: all 0.2s;
        }

        input.with-prefix {
            padding-left: 52px;
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.2);
        }

        .pin-inputs {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .pin-digit {
            width: 60px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            background: var(--surface-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            outline: none;
            transition: all 0.2s;
        }

        .pin-digit:focus {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .pin-digit.filled {
            border-color: var(--primary);
            background: rgba(0, 102, 255, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0052CC;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--surface-elevated);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        .message.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--error);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .message.success {
            background: rgba(0, 185, 105, 0.1);
            color: var(--success);
            border: 1px solid rgba(0, 185, 105, 0.2);
        }

        .message.info {
            background: rgba(0, 102, 255, 0.1);
            color: var(--primary);
            border: 1px solid rgba(0, 102, 255, 0.2);
        }

        .loading {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .vendor-skip {
            text-align: center;
            margin-top: 16px;
        }

        .vendor-skip a {
            color: var(--primary);
            text-decoration: none;
            font-size: 14px;
        }

        .vendor-skip a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">TUMA</div>
        <h1>Welcome to Tuma</h1>
        <p class="subtitle">Fast & Reliable Delivery</p>

        <!-- Messages -->
        <div class="message error" id="errorMsg"></div>
        <div class="message success" id="successMsg"></div>
        <div class="message info" id="infoMsg"></div>

        <!-- Step 1: Choose User Type -->
        <div id="step1" class="step active">
            <div class="user-type-grid">
                <div class="user-type-card" onclick="selectUserType('vendor')">
                    <div class="user-icon">üì¶</div>
                    <div class="user-type-name">Send Parcel</div>
                    <div class="user-type-desc">Book delivery</div>
                </div>
                
                <div class="user-type-card" onclick="goToTracking()">
                    <div class="user-icon">üìç</div>
                    <div class="user-type-name">Track Parcel</div>
                    <div class="user-type-desc">No login needed</div>
                </div>
                
                <div class="user-type-card" onclick="selectUserType('rider')">
                    <div class="user-icon">üèçÔ∏è</div>
                    <div class="user-type-name">Rider</div>
                    <div class="user-type-desc">Deliver & earn</div>
                </div>
                
                <div class="user-type-card" onclick="selectUserType('agent')">
                    <div class="user-icon">üíº</div>
                    <div class="user-type-name">Agent</div>
                    <div class="user-type-desc">Earn commissions</div>
                </div>
            </div>
        </div>

        <!-- Step 2: Enter Phone Number -->
        <div id="step2" class="step">
            <div class="form-group">
                <label>Enter your phone number</label>
                <div class="input-wrapper">
                    <span class="phone-prefix">+254</span>
                    <input 
                        type="tel" 
                        id="phoneInput"
                        class="with-prefix"
                        placeholder="712345678"
                        maxlength="9"
                        pattern="[0-9]{9}"
                    >
                </div>
            </div>

            <button class="btn btn-primary" onclick="checkPhone()">
                <span>Continue</span>
            </button>

            <button class="btn btn-secondary" onclick="backToStep1()">
                Back
            </button>
        </div>

        <!-- Step 3: Login with PIN (Existing Users) -->
        <div id="step3Login" class="step">
            <h2 style="text-align: center; margin-bottom: 24px;">Welcome Back!</h2>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 24px;">
                Enter your 4-digit PIN to continue
            </p>

            <div class="pin-inputs">
                <input type="password" class="pin-digit login-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                <input type="password" class="pin-digit login-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                <input type="password" class="pin-digit login-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                <input type="password" class="pin-digit login-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
            </div>

            <button class="btn btn-primary" onclick="loginWithPIN()">
                <span>Sign In</span>
            </button>

            <button class="btn btn-secondary" onclick="forgotPIN()">
                Forgot PIN?
            </button>

            <button class="btn btn-secondary" onclick="backToStep2()">
                Use Different Number
            </button>
        </div>

        <!-- Step 3: Register (New Users) -->
        <div id="step3Register" class="step">
            <h2 style="margin-bottom: 20px;">Quick Sign Up</h2>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">
                Create an account to track all your deliveries
            </p>

            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="fullName" placeholder="John Doe" required>
            </div>

            <div class="form-group" id="emailGroup">
                <label>Email (Optional)</label>
                <input type="email" id="email" placeholder="john@example.com">
                <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                    For delivery receipts and notifications
                </p>
            </div>

            <div class="form-group">
                <label>Create a 4-digit PIN</label>
                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                    You'll use this PIN to sign in next time
                </p>
                <div class="pin-inputs">
                    <input type="password" class="pin-digit new-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="password" class="pin-digit new-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="password" class="pin-digit new-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="password" class="pin-digit new-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                </div>
            </div>

            <button class="btn btn-primary" onclick="createAccount()">
                <span>Create Account & Continue</span>
            </button>

            <p style="text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary);">
                By creating an account, you can track all your deliveries and save addresses for faster booking
            </p>

            <button class="btn btn-secondary" onclick="backToStep2()">
                Back
            </button>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://btxavqfoirdzwpfrvezp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0eGF2cWZvaXJkendwZnJ2ZXpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0ODcxMTcsImV4cCI6MjA2NzA2MzExN30.kQKpukFGx-cBl1zZRuXmex02ifkZ751WCUfQPogYutk';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        let state = {
            userType: null,
            phone: null,
            isNewUser: false
        };

        // Navigation functions
        function selectUserType(type) {
            state.userType = type;
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
        }

        function goToTracking() {
            window.location.href = './tracking.html';
        }

        function backToStep1() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
        }

        function backToStep2() {
            document.getElementById('step3Login').classList.remove('active');
            document.getElementById('step3Register').classList.remove('active');
            document.getElementById('step2').classList.add('active');
        }

        // Continue without account (for vendors)
        function continueWithoutAccount() {
            const phone = document.getElementById('phoneInput').value;
            
            if (!/^[0-9]{9}$/.test(phone)) {
                showError('Please enter a valid 9-digit phone number first');
                return;
            }
            
            // Store phone in sessionStorage to pass to vendor.html
            const phoneWithPrefix = '0' + phone;
            sessionStorage.setItem('tuma_temp_phone', phoneWithPrefix);
            
            // Redirect to vendor.html with phone parameter
            window.location.href = `./vendor.html?phone=${phoneWithPrefix}`;
        }

        // Check if phone exists
        async function checkPhone() {
            const phone = document.getElementById('phoneInput').value;
            
            if (!/^[0-9]{9}$/.test(phone)) {
                showError('Please enter a valid 9-digit phone number');
                return;
            }

            state.phone = '0' + phone; // Store with 0 prefix
            
            const btn = event.target.closest('.btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div><span>Checking...</span>';

            try {
                // Check in the appropriate table based on user type
                let tableName = state.userType === 'vendor' ? 'vendors' : 
                               state.userType === 'rider' ? 'riders' : 
                               state.userType === 'agent' ? 'agents' : 'vendors';
                
                const { data, error } = await supabaseClient
                    .from(tableName)
                    .select('*')
                    .eq('phone', state.phone)
                    .single();

                if (data) {
                    // Check if they have a PIN in vendor_pins table
                    const { data: pinData } = await supabaseClient
                        .from('vendor_pins')
                        .select('*')
                        .eq('vendor_id', data.id)
                        .eq('is_active', true)
                        .single();
                    
                    if (pinData) {
                        // Existing user with PIN - show login
                        state.isNewUser = false;
                        document.getElementById('step2').classList.remove('active');
                        document.getElementById('step3Login').classList.add('active');
                        
                        // Focus first PIN input
                        document.querySelector('.login-pin').focus();
                    } else {
                        // User exists but no PIN - show registration
                        state.isNewUser = true;
                        state.existingUserId = data.id;
                        document.getElementById('step2').classList.remove('active');
                        document.getElementById('step3Register').classList.add('active');
                    }
                } else {
                    // New user - show registration
                    state.isNewUser = true;
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step3Register').classList.add('active');
                }

            } catch (error) {
                // No user found - show registration
                state.isNewUser = true;
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step3Register').classList.add('active');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Continue</span>';
            }
        }

        // Login with PIN
        async function loginWithPIN() {
            const pin = Array.from(document.querySelectorAll('.login-pin'))
                .map(input => input.value)
                .join('');

            if (pin.length !== 4) {
                showError('Please enter your 4-digit PIN');
                return;
            }

            const btn = event.target.closest('.btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div><span>Signing in...</span>';

            try {
                // Get vendor ID first
                const tableName = state.userType === 'vendor' ? 'vendors' : 
                                 state.userType === 'rider' ? 'riders' : 
                                 state.userType === 'agent' ? 'agents' : 'vendors';
                
                const { data: userData } = await supabaseClient
                    .from(tableName)
                    .select('*')
                    .eq('phone', state.phone)
                    .single();
                
                if (!userData) {
                    showError('User not found');
                    return;
                }
                
                // Hash the PIN
                const pinHash = await hashPIN(pin);
                
                // Verify PIN
                const { data: pinData, error } = await supabaseClient
                    .from('vendor_pins')
                    .select('*')
                    .eq('vendor_id', userData.id)
                    .eq('pin_hash', pinHash)
                    .eq('is_active', true)
                    .single();

                if (error || !pinData) {
                    // Update failed attempts
                    await updateFailedAttempts(userData.id);
                    showError('Incorrect PIN. Please try again.');
                    btn.disabled = false;
                    btn.innerHTML = '<span>Sign In</span>';
                    return;
                }

                // Check if account is locked
                if (pinData.locked_until && new Date(pinData.locked_until) > new Date()) {
                    const minutesLeft = Math.ceil((new Date(pinData.locked_until) - new Date()) / 60000);
                    showError(`Account locked. Try again in ${minutesLeft} minutes`);
                    return;
                }

                // Update last used
                await supabaseClient
                    .from('vendor_pins')
                    .update({ 
                        last_used: new Date().toISOString(),
                        failed_attempts: 0
                    })
                    .eq('id', pinData.id);

                // Create session
                const sessionToken = generateSessionToken();
                const sessionData = {
                    vendor_id: userData.id,
                    session_token: sessionToken,
                    expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                };
                
                await supabaseClient
                    .from('vendor_sessions')
                    .insert(sessionData);
                
                // Store in localStorage
                localStorage.setItem('tuma_vendor_session', JSON.stringify({
                    token: sessionToken,
                    vendor: userData,
                    timestamp: Date.now()
                }));
                
                showSuccess('Welcome back!');
                
                // Redirect based on user type
                setTimeout(() => {
                    if (state.userType === 'vendor') {
                        window.location.href = './vendor-dashboard.html';
                    } else if (state.userType === 'agent') {
                        window.location.href = './agent-dashboard.html';
                    } else if (state.userType === 'rider') {
                        window.location.href = './rider-dashboard.html';
                    }
                }, 1000);

            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Sign In</span>';
            }
        }

        // Create account
        async function createAccount() {
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const pin = Array.from(document.querySelectorAll('.new-pin'))
                .map(input => input.value)
                .join('');

            if (!fullName) {
                showError('Please enter your full name');
                return;
            }

            if (pin.length !== 4) {
                showError('Please create a 4-digit PIN');
                return;
            }

            const btn = event.target.closest('.btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div><span>Creating account...</span>';

            try {
                let userId;
                
                // Create or update user record
                if (state.existingUserId) {
                    // User exists, just update name if needed
                    userId = state.existingUserId;
                    
                    const tableName = state.userType === 'vendor' ? 'vendors' : 
                                     state.userType === 'rider' ? 'riders' : 
                                     state.userType === 'agent' ? 'agents' : 'vendors';
                    
                    await supabaseClient
                        .from(tableName)
                        .update({
                            [state.userType === 'vendor' ? 'vendor_name' : 
                             state.userType === 'agent' ? 'agent_name' : 
                             'rider_name']: fullName,
                            email: email || null
                        })
                        .eq('id', userId);
                } else {
                    // Create new user
                    const tableName = state.userType === 'vendor' ? 'vendors' : 
                                     state.userType === 'rider' ? 'riders' : 
                                     state.userType === 'agent' ? 'agents' : 'vendors';
                    
                    const userData = {
                        phone: state.phone,
                        email: email || null,
                        status: 'active',
                        created_at: new Date().toISOString()
                    };
                    
                    // Add type-specific fields
                    if (state.userType === 'vendor') {
                        userData.vendor_name = fullName;
                        userData.vendor_type = 'casual';
                    } else if (state.userType === 'agent') {
                        userData.agent_name = fullName;
                        userData.agent_code = generateAgentCode(fullName);
                        userData.commission_rate = 0.10;
                    } else if (state.userType === 'rider') {
                        userData.rider_name = fullName;
                        userData.vehicle_type = 'motorcycle';
                    }
                    
                    const { data, error } = await supabaseClient
                        .from(tableName)
                        .insert(userData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    userId = data.id;
                }
                
                // Create PIN
                const pinHash = await hashPIN(pin);
                await supabaseClient
                    .from('vendor_pins')
                    .insert({
                        vendor_id: userId,
                        pin_hash: pinHash,
                        pin_type: 'primary',
                        is_active: true,
                        created_by: 'self'
                    });
                
                showSuccess('Account created successfully!');
                
                // Auto-login
                setTimeout(() => {
                    loginWithPIN();
                }, 1000);
                
            } catch (error) {
                console.error('Registration error:', error);
                showError('Failed to create account. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Create Account</span>';
            }
        }

        // Update failed attempts
        async function updateFailedAttempts(vendorId) {
            const { data: pinData } = await supabaseClient
                .from('vendor_pins')
                .select('*')
                .eq('vendor_id', vendorId)
                .eq('is_active', true)
                .single();
            
            if (pinData) {
                const newAttempts = (pinData.failed_attempts || 0) + 1;
                const updateData = { failed_attempts: newAttempts };
                
                // Lock after 5 failed attempts
                if (newAttempts >= 5) {
                    updateData.locked_until = new Date(Date.now() + 15 * 60000).toISOString();
                }
                
                await supabaseClient
                    .from('vendor_pins')
                    .update(updateData)
                    .eq('id', pinData.id);
            }
        }

        // Forgot PIN
        async function forgotPIN() {
            showInfo('PIN reset feature coming soon. Please contact support.');
        }

        // Helper functions
        async function hashPIN(pin) {
            const encoder = new TextEncoder();
            const data = encoder.encode(`${pin}:tuma-salt-2024`);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        function generateSessionToken() {
            return Math.random().toString(36).substring(2, 15) + 
                   Math.random().toString(36).substring(2, 15);
        }

        function generateAgentCode(name) {
            const letters = name.toUpperCase()
                .replace(/[^A-Z]/g, '')
                .substring(0, 2)
                .padEnd(2, 'X');
            const numbers = Math.floor(Math.random() * 900 + 100);
            return `${letters}${numbers}`;
        }

        // Setup PIN inputs
        document.querySelectorAll('.pin-digit').forEach((input, index, inputs) => {
            input.addEventListener('input', (e) => {
                if (e.target.value) {
                    e.target.classList.add('filled');
                    if (index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                } else {
                    e.target.classList.remove('filled');
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    inputs[index - 1].focus();
                }
            });
        });

        // Message functions
        function showError(message) {
            const el = document.getElementById('errorMsg');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const el = document.getElementById('successMsg');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);
        }

        function showInfo(message) {
            const el = document.getElementById('infoMsg');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);
        }

        // Check for existing session on load
        async function checkSession() {
            const session = localStorage.getItem('tuma_vendor_session');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    
                    // Verify session is still valid
                    const { data } = await supabaseClient
                        .from('vendor_sessions')
                        .select('*')
                        .eq('session_token', sessionData.token)
                        .gt('expires_at', new Date().toISOString())
                        .single();
                    
                    if (data) {
                        // Valid session - redirect to dashboard
                        window.location.href = './vendor-dashboard.html';
                    }
                } catch (error) {
                    // Invalid session - clear it
                    localStorage.removeItem('tuma_vendor_session');
                }
            }
        }

        checkSession();
    </script>
</body>
</html>
