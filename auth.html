<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuma - Sign In</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066FF;
            --whatsapp: #25D366;
            --background: #000000;
            --surface: #0A0A0A;
            --surface-elevated: #141414;
            --text-primary: #FFFFFF;
            --text-secondary: #888888;
            --border: #222222;
            --error: #FF3B30;
            --success: #00B969;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-container {
            width: 100%;
            max-width: 420px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 10px 40px rgba(0, 102, 255, 0.1);
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: var(--primary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            color: white;
        }

        h1 {
            text-align: center;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .user-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .user-type-card {
            background: var(--surface-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .user-type-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .user-type-card.active {
            border-color: var(--primary);
            background: rgba(0, 102, 255, 0.1);
        }

        .user-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .user-type-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-type-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .input-wrapper {
            position: relative;
        }

        .phone-prefix {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 14px 16px;
            background: var(--surface-elevated);
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            color: var(--text-primary);
            outline: none;
            transition: all 0.2s;
        }

        input.with-prefix {
            padding-left: 52px;
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.2);
        }

        .pin-inputs {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .pin-digit {
            width: 60px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            background: var(--surface-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            outline: none;
            transition: all 0.2s;
        }

        .pin-digit:focus {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .pin-digit.filled {
            border-color: var(--primary);
            background: rgba(0, 102, 255, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0052CC;
            transform: translateY(-1px);
        }

        .btn-whatsapp {
            background: var(--whatsapp);
            color: white;
        }

        .btn-whatsapp:hover {
            background: #20BA5C;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--surface-elevated);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        .message.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--error);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .message.success {
            background: rgba(0, 185, 105, 0.1);
            color: var(--success);
            border: 1px solid rgba(0, 185, 105, 0.2);
        }

        .message.info {
            background: rgba(0, 102, 255, 0.1);
            color: var(--primary);
            border: 1px solid rgba(0, 102, 255, 0.2);
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border);
        }

        .divider span {
            background: var(--surface);
            padding: 0 12px;
            position: relative;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .verification-info {
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
        }

        .verification-info h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--whatsapp);
        }

        .verification-info ol {
            margin-left: 20px;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.8;
        }

        .loading {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .vendor-skip {
            text-align: center;
            margin-top: 16px;
        }

        .vendor-skip a {
            color: var(--primary);
            text-decoration: none;
            font-size: 14px;
        }

        .vendor-skip a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">2MA</div>
        <h1>Welcome to 2MA</h1>
        <p class="subtitle">Fast & Reliable Delivery</p>

        <!-- Messages -->
        <div class="message error" id="errorMsg"></div>
        <div class="message success" id="successMsg"></div>
        <div class="message info" id="infoMsg"></div>

        <!-- Step 1: Choose User Type -->
        <div id="step1" class="step active">
            <div class="user-type-grid">
                <div class="user-type-card" onclick="selectUserType('vendor')">
                    <div class="user-icon">üì¶</div>
                    <div class="user-type-name">Send Parcel</div>
                    <div class="user-type-desc">Book delivery</div>
                </div>
                
                <div class="user-type-card" onclick="goToTracking()">
                    <div class="user-icon">üìç</div>
                    <div class="user-type-name">Track Parcel</div>
                    <div class="user-type-desc">No login needed</div>
                </div>
                
                <div class="user-type-card" onclick="selectUserType('rider')">
                    <div class="user-icon">üèçÔ∏è</div>
                    <div class="user-type-name">Rider</div>
                    <div class="user-type-desc">Deliver & earn</div>
                </div>
                
                <div class="user-type-card" onclick="selectUserType('affiliate')">
                    <div class="user-icon">üíº</div>
                    <div class="user-type-name">Affiliate</div>
                    <div class="user-type-desc">Earn up to 20% commission</div>
                </div>
            </div>
        </div>

        <!-- Step 2: Enter Phone Number -->
        <div id="step2" class="step">
            <div class="form-group">
                <label>Enter your phone number</label>
                <div class="input-wrapper">
                    <span class="phone-prefix">+254</span>
                    <input 
                        type="tel" 
                        id="phoneInput"
                        class="with-prefix"
                        placeholder="712345678"
                        maxlength="9"
                        pattern="[0-9]{9}"
                    >
                </div>
            </div>

            <button class="btn btn-primary" onclick="checkPhone()">
                <span>Continue</span>
            </button>

            <div class="vendor-skip" id="vendorSkip" style="display: none;">
                <a href="./vendor.html">Continue without account ‚Üí</a>
            </div>

            <button class="btn btn-secondary" onclick="backToStep1()">
                Back
            </button>
        </div>

        <!-- Step 3: Login with PIN (Existing Users) -->
        <div id="step3Login" class="step">
            <h2 style="text-align: center; margin-bottom: 24px;">Welcome Back!</h2>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 24px;">
                Enter your 4-digit PIN to continue
            </p>

            <div class="pin-inputs">
                <input type="password" class="pin-digit login-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                <input type="password" class="pin-digit login-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                <input type="password" class="pin-digit login-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                <input type="password" class="pin-digit login-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
            </div>

            <button class="btn btn-primary" onclick="loginWithPIN()">
                <span>Sign In</span>
            </button>

            <button class="btn btn-secondary" onclick="forgotPIN()">
                Forgot PIN?
            </button>

            <button class="btn btn-secondary" onclick="backToStep2()">
                Use Different Number
            </button>
        </div>

        <!-- Step 3: Register (New Users) -->
        <div id="step3Register" class="step">
            <h2 style="margin-bottom: 20px;">Create Your Account</h2>

            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="fullName" placeholder="John Doe">
            </div>

            <div class="form-group" id="emailGroup">
                <label>Email (Optional)</label>
                <input type="email" id="email" placeholder="john@example.com">
            </div>

            <!-- Affiliate-specific fields -->
            <div id="affiliateFields" style="display: none;">
                <div class="form-group">
                    <label>National ID Number</label>
                    <input type="text" id="nationalId" placeholder="12345678" maxlength="8">
                </div>
                
                <div class="form-group">
                    <label>M-Pesa Number (for payments)</label>
                    <div class="input-wrapper">
                        <span class="phone-prefix">+254</span>
                        <input type="tel" id="mpesaNumber" class="with-prefix" placeholder="712345678" maxlength="9">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Create a 4-digit PIN</label>
                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                    You'll use this PIN to sign in next time
                </p>
                <div class="pin-inputs">
                    <input type="password" class="pin-digit new-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="password" class="pin-digit new-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="password" class="pin-digit new-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="password" class="pin-digit new-pin" maxlength="1" pattern="[0-9]" inputmode="numeric">
                </div>
            </div>

            <button class="btn btn-whatsapp" onclick="sendVerification()">
                <svg class="whatsapp-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.149-.67.149-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414-.074-.123-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
                <span>Verify via WhatsApp</span>
            </button>

            <button class="btn btn-secondary" onclick="backToStep2()">
                Back
            </button>
        </div>

        <!-- Step 4: WhatsApp Verification Sent -->
        <div id="step4Verification" class="step">
            <div style="text-align: center;">
                <div style="font-size: 64px; margin-bottom: 24px;">üì±</div>
                <h2 style="margin-bottom: 16px;">Check WhatsApp!</h2>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">
                    We've sent a verification link to<br>
                    <strong id="phoneDisplay"></strong>
                </p>
            </div>

            <div class="verification-info">
                <h3>üìå Next Steps:</h3>
                <ol>
                    <li>Open WhatsApp on your phone</li>
                    <li>Look for message from 2MA</li>
                    <li>Click the verification link</li>
                    <li>You'll be logged in automatically</li>
                </ol>
            </div>

            <button class="btn btn-whatsapp" onclick="resendVerification()">
                <span>Resend Link</span>
            </button>

            <button class="btn btn-secondary" onclick="checkVerification()">
                I've Clicked the Link
            </button>

            <button class="btn btn-secondary" onclick="backToStep3()">
                Back
            </button>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://btxavqfoirdzwpfrvezp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0eGF2cWZvaXJkendwZnJ2ZXpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0ODcxMTcsImV4cCI6MjA2NzA2MzExN30.kQKpukFGx-cBl1zZRuXmex02ifkZ751WCUfQPogYutk';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        let state = {
            userType: null, // Will be 'affiliate' in UI but 'agent' in DB
            phone: null,
            isNewUser: false,
            formData: {},
            verificationToken: null
        };

        // Navigation functions
        function selectUserType(type) {
            state.userType = type;
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            
            // Show skip option for vendors
            if (type === 'vendor') {
                document.getElementById('vendorSkip').style.display = 'block';
            }
            
            // Show affiliate fields
            if (type === 'affiliate') {
                document.getElementById('affiliateFields').style.display = 'block';
            }
        }

        function goToTracking() {
            window.location.href = './tracking.html';
        }

        function backToStep1() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
        }

        function backToStep2() {
            document.getElementById('step3Login').classList.remove('active');
            document.getElementById('step3Register').classList.remove('active');
            document.getElementById('step2').classList.add('active');
        }

        function backToStep3() {
            document.getElementById('step4Verification').classList.remove('active');
            document.getElementById('step3Register').classList.add('active');
        }

        // Check if phone exists
        async function checkPhone() {
            const phone = document.getElementById('phoneInput').value;
            
            if (!/^[0-9]{9}$/.test(phone)) {
                showError('Please enter a valid 9-digit phone number');
                return;
            }

            state.phone = '0' + phone; // Store with 0 prefix
            
            const btn = event.target.closest('.btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div><span>Checking...</span>';

            try {
                // Check if user exists in user_auth table
                const { data, error } = await supabase
                    .from('user_auth')
                    .select('phone, user_type')
                    .eq('phone', state.phone)
                    .single();

                if (data) {
                    // Existing user - show PIN login
                    state.isNewUser = false;
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step3Login').classList.add('active');
                    
                    // Focus first PIN input
                    document.querySelector('.login-pin').focus();
                } else {
                    // New user - show registration
                    state.isNewUser = true;
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step3Register').classList.add('active');
                }

            } catch (error) {
                // No user found - show registration
                state.isNewUser = true;
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step3Register').classList.add('active');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Continue</span>';
            }
        }

        // Login with PIN
        async function loginWithPIN() {
            const pin = Array.from(document.querySelectorAll('.login-pin'))
                .map(input => input.value)
                .join('');

            if (pin.length !== 4) {
                showError('Please enter your 4-digit PIN');
                return;
            }

            const btn = event.target.closest('.btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div><span>Signing in...</span>';

            try {
                // Hash the PIN
                const pinHash = await hashPIN(pin);
                
                // Verify PIN
                const { data, error } = await supabase
                    .from('user_auth')
                    .select('*')
                    .eq('phone', state.phone)
                    .eq('pin_hash', pinHash)
                    .single();

                if (error || !data) {
                    showError('Incorrect PIN. Please try again.');
                    btn.disabled = false;
                    btn.innerHTML = '<span>Sign In</span>';
                    return;
                }

                // Update last login
                await supabase
                    .from('user_auth')
                    .update({ last_login: new Date().toISOString() })
                    .eq('phone', state.phone);

                // Sign in with Supabase Auth
                const email = `${state.phone.replace('+254', '254')}@2ma.local`;
                const password = generatePassword(pin);
                
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (authError) {
                    console.error('Auth error:', authError);
                    // Still proceed if user_auth verification passed
                }

                showSuccess('Welcome back!');
                
                // Redirect based on user type
                setTimeout(() => {
                    const redirects = {
                        vendor: './vendor.html',
                        agent: './agent.html', // Database uses 'agent'
                        affiliate: './agent.html', // UI uses 'affiliate' but goes to agent.html
                        rider: './rider.html'
                    };
                    window.location.href = redirects[data.user_type] || './';
                }, 1000);

            } catch (error) {
                showError('Login failed. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Sign In</span>';
            }
        }

        // Send WhatsApp verification
        async function sendVerification() {
            // Validate form
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const pin = Array.from(document.querySelectorAll('.new-pin'))
                .map(input => input.value)
                .join('');

            if (!fullName) {
                showError('Please enter your full name');
                return;
            }

            if (pin.length !== 4) {
                showError('Please create a 4-digit PIN');
                return;
            }

            // Affiliate validation
            if (state.userType === 'affiliate') {
                const nationalId = document.getElementById('nationalId').value;
                const mpesaNumber = document.getElementById('mpesaNumber').value;
                
                if (!nationalId || !mpesaNumber) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                state.formData.nationalId = nationalId;
                state.formData.mpesaNumber = '0' + mpesaNumber;
            }

            // Store form data
            state.formData = {
                ...state.formData,
                fullName,
                email,
                pin
            };

            // Generate verification token
            state.verificationToken = generateToken();
            
            // Store pending registration
            try {
                await storePendingRegistration();
                
                // Generate WhatsApp link
                const verificationUrl = `${window.location.origin}/verify.html?token=${state.verificationToken}`;
                const message = `Welcome to 2MA! üöÄ\n\nClick this link to verify your account:\n${verificationUrl}\n\nYour verification code: ${state.verificationToken}\n\nThis link expires in 30 minutes.`;
                
                // Open WhatsApp
                const whatsappUrl = `https://wa.me/${state.phone.replace('0', '254')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Show verification screen
                document.getElementById('phoneDisplay').textContent = '+254' + state.phone.substring(1);
                document.getElementById('step3Register').classList.remove('active');
                document.getElementById('step4Verification').classList.add('active');
                
                showInfo('WhatsApp opened! Send the message to receive your verification link.');
                
            } catch (error) {
                showError('Failed to create account. Please try again.');
            }
        }

        // Store pending registration
        async function storePendingRegistration() {
            const pinHash = await hashPIN(state.formData.pin);
            
            // Create Supabase Auth account
            const email = `${state.phone.replace('+254', '254')}@2ma.local`;
            const password = generatePassword(state.formData.pin);
            
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        phone: state.phone,
                        full_name: state.formData.fullName,
                        user_type: state.userType
                    }
                }
            });

            if (authError) throw authError;

            // Store in user_auth table
            const { error: dbError } = await supabase
                .from('user_auth')
                .insert({
                    phone: state.phone,
                    pin_hash: pinHash,
                    email: state.formData.email || null,
                    user_type: state.userType === 'affiliate' ? 'agent' : state.userType, // Map affiliate to agent in DB
                    created_at: new Date().toISOString()
                });

            if (dbError) throw dbError;

            // Create type-specific record
            if (state.userType === 'affiliate') {
                const affiliateCode = generateAffiliateCode(state.formData.fullName);
                
                await supabase.from('agents').insert({
                    auth_user_id: authData.user.id,
                    agent_name: state.formData.fullName,
                    agent_code: affiliateCode,
                    phone: state.phone,
                    email: state.formData.email || null,
                    password_hash: pinHash, // For compatibility
                    pin: state.formData.pin, // Store plain PIN temporarily
                    national_id: state.formData.nationalId,
                    mpesa_number: state.formData.mpesaNumber,
                    status: 'pending',
                    commission_rate: 0.20, // Up to 20% based on performance
                    type: 'external' // Keep original database value
                });
                
                showSuccess(`Account created! Your affiliate code is: ${affiliateCode}`);
                
            } else if (state.userType === 'vendor') {
                await supabase.from('vendors').insert({
                    auth_user_id: authData.user.id,
                    vendor_name: state.formData.fullName,
                    phone: state.phone,
                    email: state.formData.email || null,
                    vendor_type: 'casual',
                    status: 'active'
                });
                
                showSuccess('Account created successfully!');
            }
        }

        // Check verification status
        async function checkVerification() {
            // In production, this would check if the verification link was clicked
            // For now, we'll assume it was verified
            showSuccess('Account verified! Redirecting...');
            
            setTimeout(() => {
                const redirects = {
                    vendor: './vendor.html',
                    agent: './agent.html', // Keep agent.html file
                    affiliate: './agent.html', // UI shows affiliate but uses agent.html
                    rider: './rider.html'
                };
                window.location.href = redirects[state.userType] || './';
            }, 1500);
        }

        // Resend verification
        function resendVerification() {
            sendVerification();
            showSuccess('Verification link resent!');
        }

        // Forgot PIN
        async function forgotPIN() {
            showInfo('Opening WhatsApp for PIN reset...');
            
            const resetToken = generateToken();
            const resetUrl = `${window.location.origin}/reset-pin.html?token=${resetToken}&phone=${state.phone}`;
            const message = `2MA PIN Reset üîê\n\nClick this link to reset your PIN:\n${resetUrl}\n\nThis link expires in 15 minutes.`;
            
            const whatsappUrl = `https://wa.me/${state.phone.replace('0', '254')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Helper functions
        async function hashPIN(pin) {
            const encoder = new TextEncoder();
            const data = encoder.encode(`${pin}:2ma-salt-2024`);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        function generatePassword(pin) {
            // Convert PIN to a complex password deterministically
            return `2MA2024!${pin}#Secure${pin}`;
        }

        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + 
                   Math.random().toString(36).substring(2, 15);
        }

        function generateAffiliateCode(name) {
            const letters = name.toUpperCase()
                .replace(/[^A-Z]/g, '')
                .substring(0, 2)
                .padEnd(2, 'X');
            const numbers = Math.floor(Math.random() * 900 + 100);
            return `${letters}${numbers}`;
        }

        // Setup PIN inputs
        document.querySelectorAll('.pin-digit').forEach((input, index, inputs) => {
            input.addEventListener('input', (e) => {
                if (e.target.value) {
                    e.target.classList.add('filled');
                    if (index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                } else {
                    e.target.classList.remove('filled');
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    inputs[index - 1].focus();
                }
            });
        });

        // Message functions
        function showError(message) {
            const el = document.getElementById('errorMsg');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const el = document.getElementById('successMsg');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);
        }

        function showInfo(message) {
            const el = document.getElementById('infoMsg');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);
        }

        // Check for existing session on load
        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                // Get user type from user_auth
                const phone = session.user.user_metadata.phone;
                const { data } = await supabase
                    .from('user_auth')
                    .select('user_type')
                    .eq('phone', phone)
                    .single();
                
                if (data) {
                    const redirects = {
                        vendor: './vendor.html',
                        agent: './agent.html', // Database returns 'agent'
                        rider: './rider.html'
                    };
                    window.location.href = redirects[data.user_type] || './';
                }
            }
        }

        checkSession();
    </script>
</body>
</html>
