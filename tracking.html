<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Track Delivery - Tuma</title>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #0066FF;
            --primary-dark: #0052CC;
            --surface: #0A0A0B;
            --surface-elevated: #141416;
            --surface-high: #1C1C1F;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --text-tertiary: #48484A;
            --border: #2C2C2E;
            --success: #34C759;
            --warning: #FF9F0A;
            --danger: #FF3B30;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: #000000;
            color: var(--text-primary);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--surface);
            overflow: hidden;
        }

        /* Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 11, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 0.5px solid var(--border);
            z-index: 1000;
            padding: 16px 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--surface-elevated);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .back-button:active {
            scale: 0.95;
            background: var(--surface-high);
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            position: absolute;
            top: 68px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Tracking Input Section */
        .tracking-input-section {
            padding: 20px;
            background: var(--surface-elevated);
            margin: 16px;
            border-radius: 16px;
            animation: slideUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-container {
            position: relative;
            margin-bottom: 16px;
        }

        .input-field {
            width: 100%;
            background: var(--surface-high);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            font-size: 18px;
            color: var(--text-primary);
            transition: all 0.3s;
            outline: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'SF Mono', monospace;
        }

        .input-field:focus {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 102, 255, 0.2);
        }

        .track-button {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .track-button:active {
            scale: 0.98;
        }

        .track-button:disabled {
            background: var(--surface-high);
            opacity: 0.6;
        }

        /* Recent Parcels */
        .recent-parcels {
            margin: 16px;
        }

        .recent-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recent-list {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .recent-list::-webkit-scrollbar {
            display: none;
        }

        .recent-item {
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .recent-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .recent-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .recent-status.delivered {
            background: var(--success);
        }

        .recent-status.transit {
            background: var(--primary);
        }

        .recent-status.pending {
            background: var(--warning);
        }

        /* Status Timeline */
        .status-timeline {
            background: var(--surface-elevated);
            margin: 16px;
            padding: 20px;
            border-radius: 16px;
        }

        .timeline-item {
            display: flex;
            align-items: flex-start;
            position: relative;
            padding-bottom: 24px;
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 40px;
            width: 2px;
            height: calc(100% - 16px);
            background: var(--border);
        }

        .timeline-item.completed:not(:last-child)::before {
            background: var(--success);
        }

        .timeline-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface-high);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 1;
            transition: all 0.3s;
        }

        .timeline-item.completed .timeline-icon {
            background: var(--success);
        }

        .timeline-item.active .timeline-icon {
            background: var(--primary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 102, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 102, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 102, 255, 0); }
        }

        .timeline-content {
            margin-left: 16px;
            flex: 1;
        }

        .timeline-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .timeline-time {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .timeline-location {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* Map Container */
        .map-container {
            position: relative;
            height: 300px;
            margin: 16px;
            border-radius: 16px;
            overflow: hidden;
            background: var(--surface-elevated);
        }

        #trackingMap {
            height: 100%;
            width: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(20, 20, 22, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px;
            font-size: 14px;
            z-index: 400;
        }

        .map-overlay-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .map-overlay-value {
            color: var(--primary);
            font-size: 20px;
            font-weight: 700;
        }

        /* Rider Info Card */
        .rider-card {
            background: var(--surface-elevated);
            margin: 16px;
            padding: 20px;
            border-radius: 16px;
        }

        .rider-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .rider-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--surface-high);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            overflow: hidden;
        }

        .rider-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .rider-info {
            flex: 1;
        }

        .rider-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .rider-details {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .rider-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }

        .star {
            color: #FFD700;
        }

        .rider-actions {
            display: flex;
            gap: 12px;
        }

        .action-button {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--surface-high);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-button:active {
            scale: 0.95;
            background: var(--primary);
        }

        /* ETA Card */
        .eta-card {
            background: linear-gradient(135deg, var(--surface-elevated), var(--surface-high));
            margin: 16px;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }

        .eta-time {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .eta-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .progress-bar {
            height: 8px;
            background: var(--surface-high);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .eta-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .eta-stat {
            background: var(--surface-high);
            padding: 12px;
            border-radius: 10px;
        }

        .eta-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .eta-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Delivery Details */
        .details-card {
            background: var(--surface-elevated);
            margin: 16px;
            padding: 20px;
            border-radius: 16px;
        }

        .details-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .detail-value {
            font-size: 14px;
            color: var(--text-primary);
            text-align: right;
            max-width: 60%;
        }

        /* Action Buttons */
        .action-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .primary-button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .secondary-button {
            background: var(--surface-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Live Updates */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--success);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Proof of Delivery */
        .proof-section {
            background: var(--surface-elevated);
            margin: 16px;
            padding: 20px;
            border-radius: 16px;
        }

        .proof-image {
            width: 100%;
            height: 200px;
            background: var(--surface-high);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .proof-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .proof-details {
            text-align: center;
        }

        .proof-time {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .proof-signature {
            font-size: 16px;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-message {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--surface-high);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error State */
        .error-message {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid var(--danger);
            border-radius: 12px;
            padding: 16px;
            margin: 16px;
            text-align: center;
        }

        .error-title {
            color: var(--danger);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .error-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            background: var(--danger);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: white;
        }

        /* Responsive */
        @media (min-width: 428px) {
            .app {
                max-width: 428px;
                margin: 0 auto;
                box-shadow: 0 0 60px rgba(0, 0, 0, 0.5);
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <button class="back-button" onclick="window.history.back()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </button>
                <h1 class="header-title">Track Delivery</h1>
                <button class="back-button" onclick="showNotifications()" style="position: relative;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                    </svg>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Tracking Input Section -->
            <div class="tracking-input-section" id="trackingInput">
                <h2 style="font-size: 18px; margin-bottom: 16px;">Enter Parcel Code</h2>
                <div class="input-container">
                    <input type="text" 
                           class="input-field" 
                           id="parcelCodeInput" 
                           placeholder="TM******" 
                           maxlength="8"
                           autocomplete="off">
                </div>
                <button class="track-button" id="trackButton" onclick="trackParcel()" disabled>
                    <span id="buttonText">Loading...</span>
                </button>
            </div>

            <!-- Recent Parcels -->
            <div class="recent-parcels" id="recentParcels" style="display: none;">
                <h3 class="recent-title">Recent Deliveries</h3>
                <div class="recent-list" id="recentList">
                    <!-- Recent parcels will be populated here -->
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loadingState" style="display: none;">
                <div class="spinner"></div>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage" style="display: none;">
                <div class="error-title">Parcel Not Found</div>
                <div class="error-text" id="errorText">Please check the code and try again</div>
            </div>

            <!-- Tracking Details (Hidden by default) -->
            <div id="trackingDetails" style="display: none;">
                <!-- Live Indicator -->
                <div style="text-align: center; margin: 16px;">
                    <span class="live-indicator">
                        <span class="live-dot"></span>
                        LIVE TRACKING
                    </span>
                </div>

                <!-- Status Timeline -->
                <div class="status-timeline" id="statusTimeline">
                    <!-- Timeline will be populated dynamically -->
                </div>

                <!-- Map Container -->
                <div class="map-container">
                    <div id="trackingMap"></div>
                    <div class="map-overlay">
                        <div class="map-overlay-title">Distance</div>
                        <div class="map-overlay-value" id="mapDistance">-- km</div>
                    </div>
                </div>

                <!-- ETA Card -->
                <div class="eta-card" id="etaCard" style="display: none;">
                    <div class="eta-time" id="etaTime">-- min</div>
                    <div class="eta-label">Estimated Arrival</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="eta-stats">
                        <div class="eta-stat">
                            <div class="eta-stat-value" id="distanceRemaining">-- km</div>
                            <div class="eta-stat-label">Distance Remaining</div>
                        </div>
                        <div class="eta-stat">
                            <div class="eta-stat-value" id="arrivalTime">--:--</div>
                            <div class="eta-stat-label">Arrival Time</div>
                        </div>
                    </div>
                </div>

                <!-- Rider Card -->
                <div class="rider-card" id="riderCard" style="display: none;">
                    <div class="rider-header">
                        <div class="rider-photo" id="riderPhoto">
                            <span>🏍️</span>
                        </div>
                        <div class="rider-info">
                            <div class="rider-name" id="riderName">--</div>
                            <div class="rider-details" id="riderDetails">--</div>
                            <div class="rider-rating" id="riderRating">
                                <!-- Rating will be populated -->
                            </div>
                        </div>
                    </div>
                    <div class="rider-actions">
                        <button class="action-button" id="callRiderBtn" onclick="callRider()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 0 0-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
                            </svg>
                            Call
                        </button>
                        <button class="action-button" onclick="shareLocation()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                            </svg>
                            Share
                        </button>
                    </div>
                </div>

                <!-- Delivery Details -->
                <div class="details-card">
                    <h3 class="details-title">DELIVERY DETAILS</h3>
                    <div class="detail-item">
                        <span class="detail-label">Parcel Code</span>
                        <span class="detail-value" id="parcelCode">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Sender</span>
                        <span class="detail-value" id="senderName">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Recipient</span>
                        <span class="detail-value" id="recipientName">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Package Type</span>
                        <span class="detail-value" id="packageType">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Service Type</span>
                        <span class="detail-value" id="serviceType">--</span>
                    </div>
                    <div class="detail-item" id="priceDetail" style="display: none;">
                        <span class="detail-label">Delivery Fee</span>
                        <span class="detail-value" id="deliveryFee">--</span>
                    </div>
                </div>

                <!-- Proof of Delivery -->
                <div class="proof-section" id="proofSection" style="display: none;">
                    <h3 class="details-title">PROOF OF DELIVERY</h3>
                    <div class="proof-image" id="proofImage">
                        <span style="color: var(--text-secondary);">No image available</span>
                    </div>
                    <div class="proof-details">
                        <div class="proof-time" id="proofTime">--</div>
                        <div class="proof-signature" id="proofSignature">--</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-section">
                    <button class="primary-button" onclick="shareTracking()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                        </svg>
                        Share Tracking Link
                    </button>

                    <button class="secondary-button" id="downloadReceiptBtn" onclick="downloadReceipt()" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                        Download Receipt
                    </button>

                    <button class="secondary-button" onclick="reportIssue()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                        </svg>
                        Report Issue
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">📦</div>
                <h2 class="empty-title">No Active Deliveries</h2>
                <p class="empty-message">Enter a parcel code to track your delivery</p>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://btxavqfoirdzwpfrvezp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0eGF2cWZvaXJkendwZnJ2ZXpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0ODcxMTcsImV4cCI6MjA2NzA2MzExN30.kQKpukFGx-cBl1zZRuXmex02ifkZ751WCUfQPogYutk';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State Management
        let trackingState = {
            currentParcel: null,
            trackingMap: null,
            markers: {
                pickup: null,
                delivery: null,
                rider: null
            },
            routeLine: null,
            refreshInterval: null,
            realtimeSubscription: null
        };

        // Status mapping
        const statusSteps = {
            'submitted': 1,
            'assigned': 2,
            'picked_up': 3,
            'in_transit': 3,
            'out_for_delivery': 4,
            'delivered': 5,
            'cancelled': -1
        };

        const statusLabels = {
            'submitted': 'Booking Confirmed',
            'assigned': 'Rider Assigned',
            'picked_up': 'Package Picked Up',
            'in_transit': 'In Transit',
            'out_for_delivery': 'Out for Delivery',
            'delivered': 'Delivered',
            'cancelled': 'Cancelled'
        };

        // Helper function to format timestamps correctly
        function formatTimestamp(timestamp) {
            if (!timestamp) return '--:--';
            
            // Parse the timestamp - Supabase returns UTC timestamps
            const date = new Date(timestamp);
            
            // Force East Africa Time (UTC+3)
            const options = {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                timeZone: 'Africa/Nairobi' // EAT timezone
            };
            
            return date.toLocaleTimeString('en-US', options);
        }

        // Helper function to format full date and time
        function formatFullDateTime(timestamp) {
            if (!timestamp) return '--';
            
            const date = new Date(timestamp);
            
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                timeZone: 'Africa/Nairobi' // EAT timezone
            };
            
            return date.toLocaleString('en-US', options);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeTracking();
            setupEventListeners();
            loadRecentParcels();
        });

        function initializeTracking() {
            // Check for parcel code in URL params
            const urlParams = new URLSearchParams(window.location.search);
            const parcelCode = urlParams.get('parcel');
            if (parcelCode) {
                document.getElementById('parcelCodeInput').value = parcelCode;
                trackParcel();
            }
        }

        function setupEventListeners() {
            const input = document.getElementById('parcelCodeInput');
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });

            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    trackParcel();
                }
            });
        }

        async function loadRecentParcels() {
            // Load from local storage or user's recent parcels
            const recentCodes = JSON.parse(localStorage.getItem('tuma_recent_parcels') || '[]');
            
            if (recentCodes.length > 0) {
                const recentSection = document.getElementById('recentParcels');
                const recentList = document.getElementById('recentList');
                
                recentList.innerHTML = recentCodes.slice(0, 5).map(code => `
                    <div class="recent-item" onclick="quickTrack('${code}')">
                        <span class="recent-status ${getStatusClass(code)}"></span>
                        <span>${code}</span>
                    </div>
                `).join('');
                
                recentSection.style.display = 'block';
            }
        }

        async function trackParcel() {
            const parcelCode = document.getElementById('parcelCodeInput').value.trim();
            
            if (!parcelCode) {
                showError('Please enter a parcel code');
                return;
            }

            // Show loading
            showLoading();

            try {
                console.log('Searching for parcel:', parcelCode);
                
                // Query parcel from database
                const { data: parcel, error } = await window.supabaseClient
                    .from('parcels')
                    .select(`
                        *,
                        rider:riders(*)
                    `)
                    .eq('parcel_code', parcelCode)
                    .single();

                console.log('Query result:', { parcel, error });

                if (error) {
                    console.error('Supabase error:', error);
                    
                    // Try a simpler query without the join
                    console.log('Trying simple query without join...');
                    const { data: simpleParcel, error: simpleError } = await window.supabaseClient
                        .from('parcels')
                        .select('*')
                        .eq('parcel_code', parcelCode)
                        .single();
                    
                    console.log('Simple query result:', { simpleParcel, simpleError });
                    
                    if (simpleError) {
                        showError('Parcel not found. Please check the code and try again.');
                        return;
                    }
                    
                    // If simple query works, use it and fetch rider separately
                    trackingState.currentParcel = simpleParcel;
                    
                    // Try to fetch rider if rider_id exists
                    if (simpleParcel.rider_id) {
                        const { data: rider } = await window.supabaseClient
                            .from('riders')
                            .select('*')
                            .eq('id', simpleParcel.rider_id)
                            .single();
                        
                        if (rider) {
                            trackingState.currentParcel.rider = rider;
                        }
                    }
                    
                    // Save to recent parcels
                    saveToRecent(parcelCode);
                    
                    // Show tracking details
                    showTrackingDetails(trackingState.currentParcel);
                    
                    // Setup real-time updates
                    setupRealtimeUpdates(trackingState.currentParcel.id);
                    
                    // Start auto-refresh for location updates
                    startLocationRefresh();
                    
                    return;
                }

                if (!parcel) {
                    showError('Parcel not found. Please check the code and try again.');
                    return;
                }

                // Save to recent parcels
                saveToRecent(parcelCode);

                // Store current parcel
                trackingState.currentParcel = parcel;

                // Show tracking details
                showTrackingDetails(parcel);

                // Setup real-time updates
                setupRealtimeUpdates(parcel.id);

                // Start auto-refresh for location updates
                startLocationRefresh();

            } catch (error) {
                console.error('Error tracking parcel:', error);
                showError('Something went wrong. Please try again.');
            }
        }

        function showTrackingDetails(parcel) {
            // Hide other sections
            document.getElementById('trackingInput').style.display = 'none';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            
            // Show tracking details
            document.getElementById('trackingDetails').style.display = 'block';

            // Update timeline
            updateTimeline(parcel);

            // Update delivery details
            updateDeliveryDetails(parcel);

            // Show rider info if assigned
            if (parcel.rider_id && parcel.rider) {
                showRiderInfo(parcel.rider);
            }

            // Initialize or update map
            if (!trackingState.trackingMap) {
                initializeMap();
            }
            updateMap(parcel);

            // Show ETA if in transit
            if (['picked_up', 'in_transit', 'out_for_delivery'].includes(parcel.status)) {
                showETA(parcel);
            }

            // Show proof of delivery if delivered
            if (parcel.status === 'delivered' && parcel.proof_of_delivery) {
                showProofOfDelivery(parcel.proof_of_delivery);
            }
        }

        function updateTimeline(parcel) {
            const timeline = document.getElementById('statusTimeline');
            const currentStep = statusSteps[parcel.status] || 0;
            
            const steps = [
                { key: 'submitted', icon: '✅', label: 'Booking Confirmed', time: parcel.created_at },
                { key: 'assigned', icon: '🏍️', label: 'Rider Assigned', time: parcel.assigned_at },
                { key: 'picked_up', icon: '📦', label: 'Package Picked Up', time: parcel.pickup_timestamp },
                { key: 'out_for_delivery', icon: '🚀', label: 'Out for Delivery', time: parcel.pickup_timestamp },
                { key: 'delivered', icon: '✅', label: 'Delivered', time: parcel.delivery_timestamp }
            ];

            timeline.innerHTML = steps.map((step, index) => {
                const stepNumber = index + 1;
                const isCompleted = currentStep >= stepNumber;
                const isActive = currentStep === stepNumber;
                const time = formatTimestamp(step.time); // Use the helper function

                const location = step.key === 'picked_up' ? parcel.pickup_location?.address :
                               step.key === 'delivered' ? parcel.delivery_location?.address : '';

                return `
                    <div class="timeline-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}">
                        <div class="timeline-icon">${step.icon}</div>
                        <div class="timeline-content">
                            <div class="timeline-title">${step.label}</div>
                            <div class="timeline-time">${time}</div>
                            ${location ? `<div class="timeline-location">${location}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateDeliveryDetails(parcel) {
            document.getElementById('parcelCode').textContent = parcel.parcel_code;
            document.getElementById('senderName').textContent = parcel.sender_name || '--';
            document.getElementById('recipientName').textContent = parcel.recipient_name || '--';
            document.getElementById('packageType').textContent = parcel.package_type || '--';
            document.getElementById('serviceType').textContent = parcel.service_type || 'Standard';
            
            if (parcel.price) {
                document.getElementById('deliveryFee').textContent = `KES ${parcel.price}`;
                document.getElementById('priceDetail').style.display = 'flex';
            }
        }

        function showRiderInfo(rider) {
            document.getElementById('riderCard').style.display = 'block';
            document.getElementById('riderName').textContent = rider.rider_name || '--';
            document.getElementById('riderDetails').textContent = 
                `${rider.motorcycle_plate || '--'} • ${rider.vehicle_make || ''} ${rider.vehicle_model || ''}`;
            
            // Show rating
            const rating = rider.rating || 5;
            const ratingHtml = Array(5).fill(0).map((_, i) => 
                `<span class="star">${i < Math.floor(rating) ? '⭐' : '☆'}</span>`
            ).join('') + `<span style="margin-left: 8px; color: var(--text-secondary);">${rating.toFixed(1)}</span>`;
            
            document.getElementById('riderRating').innerHTML = ratingHtml;
            
            // Show rider photo if available
            if (rider.profile_photo_url) {
                document.getElementById('riderPhoto').innerHTML = `<img src="${rider.profile_photo_url}" alt="${rider.rider_name}">`;
            }
            
            // Store phone for calling
            document.getElementById('callRiderBtn').dataset.phone = rider.phone || '';
        }

        function initializeMap() {
            trackingState.trackingMap = L.map('trackingMap', {
                zoomControl: true,
                attributionControl: false
            }).setView([-1.2921, 36.8219], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(trackingState.trackingMap);
        }

        function updateMap(parcel) {
            const map = trackingState.trackingMap;
            
            // Clear existing markers and route
            Object.values(trackingState.markers).forEach(marker => {
                if (marker) map.removeLayer(marker);
            });
            if (trackingState.routeLine) {
                map.removeLayer(trackingState.routeLine);
            }

            // Add pickup marker
            if (parcel.pickup_location) {
                const pickupIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background: #0066FF; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 3px 10px rgba(0,0,0,0.5);">P</div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                trackingState.markers.pickup = L.marker(
                    [parcel.pickup_location.lat, parcel.pickup_location.lng], 
                    { icon: pickupIcon }
                )
                .addTo(map)
                .bindPopup(`<strong>Pickup</strong><br>${parcel.pickup_location.address}`);
            }

            // Add delivery marker
            if (parcel.delivery_location) {
                const deliveryIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background: #34C759; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 3px 10px rgba(0,0,0,0.5);">D</div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                trackingState.markers.delivery = L.marker(
                    [parcel.delivery_location.lat, parcel.delivery_location.lng], 
                    { icon: deliveryIcon }
                )
                .addTo(map)
                .bindPopup(`<strong>Delivery</strong><br>${parcel.delivery_location.address}`);
            }

            // Add rider marker if available
            if (parcel.rider && parcel.rider.last_location_lat && parcel.rider.last_location_lng) {
                const riderIcon = L.divIcon({
                    className: 'motorcycle-marker',
                    html: '<div style="font-size: 30px;">🏍️</div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                trackingState.markers.rider = L.marker(
                    [parcel.rider.last_location_lat, parcel.rider.last_location_lng], 
                    { icon: riderIcon }
                )
                .addTo(map)
                .bindPopup(`<strong>Rider Location</strong><br>Last updated: ${formatTimestamp(parcel.rider.last_location_update || new Date().toISOString())}`);
            }

            // Draw route if in transit
            if (parcel.status !== 'submitted' && parcel.pickup_location && parcel.delivery_location) {
                const routePoints = [];
                
                // Add pickup
                routePoints.push([parcel.pickup_location.lat, parcel.pickup_location.lng]);
                
                // Add rider location if available
                if (trackingState.markers.rider) {
                    routePoints.push([parcel.rider.last_location_lat, parcel.rider.last_location_lng]);
                }
                
                // Add delivery if not completed
                if (parcel.status !== 'delivered') {
                    routePoints.push([parcel.delivery_location.lat, parcel.delivery_location.lng]);
                }
                
                if (routePoints.length > 1) {
                    trackingState.routeLine = L.polyline(routePoints, {
                        color: '#0066FF',
                        weight: 4,
                        opacity: 0.8,
                        dashArray: parcel.status === 'delivered' ? '10, 10' : null
                    }).addTo(map);
                }
            }

            // Fit bounds
            const bounds = [];
            if (parcel.pickup_location) bounds.push([parcel.pickup_location.lat, parcel.pickup_location.lng]);
            if (parcel.delivery_location) bounds.push([parcel.delivery_location.lat, parcel.delivery_location.lng]);
            if (trackingState.markers.rider) bounds.push(trackingState.markers.rider.getLatLng());
            
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            // Update distance
            if (parcel.distance_km) {
                document.getElementById('mapDistance').textContent = `${parcel.distance_km.toFixed(1)} km`;
            }
        }

        function showETA(parcel) {
            document.getElementById('etaCard').style.display = 'block';
            
            // Calculate progress
            let progress = 0;
            if (parcel.status === 'picked_up') progress = 30;
            else if (parcel.status === 'in_transit') progress = 60;
            else if (parcel.status === 'out_for_delivery') progress = 80;
            else if (parcel.status === 'delivered') progress = 100;
            
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // Calculate ETA based on distance and average speed
            if (parcel.distance_km && parcel.rider) {
                const avgSpeed = 30; // km/h in city
                const remainingDistance = parcel.distance_km * (1 - progress / 100);
                const etaMinutes = Math.round(remainingDistance / avgSpeed * 60);
                
                document.getElementById('etaTime').textContent = `${etaMinutes} min`;
                document.getElementById('distanceRemaining').textContent = `${remainingDistance.toFixed(1)} km`;
                
                // Calculate arrival time
                const arrivalTime = new Date();
                arrivalTime.setMinutes(arrivalTime.getMinutes() + etaMinutes);
                document.getElementById('arrivalTime').textContent = formatTimestamp(arrivalTime.toISOString());
            }
        }

        function showProofOfDelivery(proof) {
            document.getElementById('proofSection').style.display = 'block';
            
            if (proof.photo_url) {
                document.getElementById('proofImage').innerHTML = `<img src="${proof.photo_url}" alt="Proof of delivery">`;
            }
            
            if (proof.delivered_at) {
                document.getElementById('proofTime').textContent = `Delivered at ${formatFullDateTime(proof.delivered_at)}`;
            }
            
            if (proof.recipient_name) {
                document.getElementById('proofSignature').textContent = `Received by: ${proof.recipient_name}`;
            }
            
            // Show download receipt button
            document.getElementById('downloadReceiptBtn').style.display = 'flex';
        }

        function setupRealtimeUpdates(parcelId) {
            // Subscribe to parcel updates
            trackingState.realtimeSubscription = window.supabaseClient
                .channel(`parcel-${parcelId}`)
                .on('postgres_changes', 
                    { 
                        event: 'UPDATE', 
                        schema: 'public', 
                        table: 'parcels',
                        filter: `id=eq.${parcelId}`
                    }, 
                    (payload) => {
                        console.log('Parcel updated:', payload);
                        trackingState.currentParcel = { ...trackingState.currentParcel, ...payload.new };
                        showTrackingDetails(trackingState.currentParcel);
                        
                        // Show notification for status changes
                        if (payload.old.status !== payload.new.status) {
                            showStatusNotification(payload.new.status);
                        }
                    }
                )
                .subscribe();
        }

        function startLocationRefresh() {
            // Refresh rider location every 30 seconds
            trackingState.refreshInterval = setInterval(async () => {
                if (trackingState.currentParcel && trackingState.currentParcel.rider_id) {
                    const { data: rider } = await window.supabaseClient
                        .from('riders')
                        .select('last_location_lat, last_location_lng, last_location_update')
                        .eq('id', trackingState.currentParcel.rider_id)
                        .single();
                    
                    if (rider && rider.last_location_lat) {
                        trackingState.currentParcel.rider = { 
                            ...trackingState.currentParcel.rider, 
                            ...rider 
                        };
                        updateMap(trackingState.currentParcel);
                    }
                }
            }, 30000);
        }

        function showStatusNotification(status) {
            const message = statusLabels[status] || 'Status updated';
            
            // Update notification badge
            const badge = document.getElementById('notificationBadge');
            const currentCount = parseInt(badge.textContent) || 0;
            badge.textContent = currentCount + 1;
            badge.style.display = 'block';
            
            // Show browser notification if permitted
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Tuma Delivery Update', {
                    body: `Your parcel status: ${message}`,
                    icon: '/icon-192x192.png'
                });
            }
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('trackingDetails').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }

        function saveToRecent(parcelCode) {
            let recent = JSON.parse(localStorage.getItem('tuma_recent_parcels') || '[]');
            recent = [parcelCode, ...recent.filter(code => code !== parcelCode)].slice(0, 10);
            localStorage.setItem('tuma_recent_parcels', JSON.stringify(recent));
        }

        function quickTrack(parcelCode) {
            document.getElementById('parcelCodeInput').value = parcelCode;
            trackParcel();
        }

        function getStatusClass(parcelCode) {
            // This would check actual status in production
            return 'transit';
        }

        // Action Functions
        function callRider() {
            const phone = document.getElementById('callRiderBtn').dataset.phone;
            if (phone) {
                window.location.href = `tel:${phone}`;
            }
        }

        function shareLocation() {
            if (trackingState.currentParcel && trackingState.currentParcel.rider) {
                const url = `https://www.google.com/maps?q=${trackingState.currentParcel.rider.last_location_lat},${trackingState.currentParcel.rider.last_location_lng}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Rider Location',
                        text: 'Current location of your delivery rider',
                        url: url
                    });
                } else {
                    window.open(url, '_blank');
                }
            }
        }

        function shareTracking() {
            const url = `${window.location.origin}/tracking.html?parcel=${trackingState.currentParcel.parcel_code}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Track My Delivery',
                    text: `Track delivery ${trackingState.currentParcel.parcel_code}`,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url);
                alert('Tracking link copied to clipboard!');
            }
        }

        function downloadReceipt() {
            // In production, this would generate a PDF receipt
            alert('Receipt download feature coming soon!');
        }

        function reportIssue() {
            const issues = [
                'Delayed delivery',
                'Wrong location',
                'Package damaged',
                'Rider not responding',
                'Other issue'
            ];
            
            const issue = prompt(`Please select an issue:\n${issues.map((i, idx) => `${idx + 1}. ${i}`).join('\n')}`);
            
            if (issue) {
                alert('Thank you for reporting. Our support team will contact you shortly.');
                // In production, this would create a support ticket
            }
        }

        function showNotifications() {
            // Reset badge
            document.getElementById('notificationBadge').style.display = 'none';
            document.getElementById('notificationBadge').textContent = '0';
            
            alert('No new notifications');
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (trackingState.refreshInterval) {
                clearInterval(trackingState.refreshInterval);
            }
            if (trackingState.realtimeSubscription) {
                trackingState.realtimeSubscription.unsubscribe();
            }
        });

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
